{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- Tutorial -->
<div class="modal fade" id="tutorialModal" tabindex="-1" aria-labelledby="tutorialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white border-light">

        <div class="modal-header">
          <h5 class="modal-title" id="tutorialModalLabel">Tutorial</h5>
        </div>

        <div class="modal-body" id="tutorial-step"> </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="skipBtn">Skip</button>
            <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
        </div>

      </div>
    </div>
  </div>

    <div class="container">
        <div class="map-container position-relative">
            <div id="map" style="height: 500px;"></div>
            <button id="helpBtn" class="btn btn-sm btn-light position-absolute" style="top: 15px; right: 15px; z-index: 1000;"> Help </button>
        </div>
    </div>

    <!-- Map Script -->

    <script>
        // Initialize the map centered at Dublin City University
        var map = L.map('map').setView([53.3858, -6.2576], 14);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Event icon
        const eventIcon = L.icon({
            iconUrl: '{% static "icons/pin.png" %}',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        const events = {{ events_json|safe }};
        const today = new Date();

        events.forEach(event => {
            const eventDate = new Date(event.date);
            if (eventDate >= today) {
                const marker = L.marker([event.lat, event.lng], { icon: eventIcon }).addTo(map);
                marker.bindPopup(`<a href="${event.url}"><strong>${event.title}</strong><br>${event.date}</a>`);
            }
        });        
        
        // Add click event to the map
        let marker;

        map.on('click', function (e) {
            const latitude = e.latlng.lat.toFixed(5);
            const longitude = e.latlng.lng.toFixed(5);

            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker([latitude, longitude]).addTo(map);

            // Show a popup with an event creation link
            marker.bindPopup(`
                <b>Selected Location</b><br>
                Latitude: ${latitude}, Longitude: ${longitude}<br>
                <a href="/create-event/?latitude=${latitude}&longitude=${longitude}" 
                   style="color:blue; text-decoration:underline;">Create Event Here</a>
            `).openPopup();
        });
    </script>

    <!-- Tutorial Script-->

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const tutorialSteps = [
        "Hello and welcome to PinPoint, your new best pal for organising events!", 
        "Our app is centered around this map in the middle. Click on the map to select a location and create a new event!", 
        "But first you might want to add some more users! Connect with fellow PinPoint users via the 'friends' tab in the bottom left. You can always return here after using the 'Home' button in the center", 
        "After you create your event, find it in an assorted list in the 'Pin' tab next to your friends!", 
        "Existing events you've created or been invited to are also marked on your map with pins. Click on them to view more details.", 
        "You can return to this guide anytime by visiting the Help section."
        ];
    
        let currentStep = 0;
        const modal = new bootstrap.Modal(document.getElementById('tutorialModal'));
        const stepContainer = document.getElementById('tutorial-step');
        const nextBtn = document.getElementById('nextBtn');
        const helpBtn = document.getElementById('helpBtn');
        const skipBtn = document.getElementById('skipBtn');


        function showStep(stepIndex) {
            stepContainer.innerText = tutorialSteps[stepIndex];
            nextBtn.innerText = stepIndex === tutorialSteps.length - 1 ? "Finish" : "Next";
        }
    
        nextBtn.addEventListener("click", function () {
            if (currentStep < tutorialSteps.length - 1) {
                currentStep++;
                showStep(currentStep);
            } else {
                modal.hide();
                localStorage.setItem("tutorialCompleted", "true");
            }
        });

        skipBtn.addEventListener("click", function () {
        localStorage.setItem("tutorialCompleted", "true");
        modal.hide();
        });
    
        helpBtn.addEventListener("click", function () {
            currentStep = 0;
            showStep(currentStep);
            modal.show();
        });
    
        if (!localStorage.getItem("tutorialCompleted")) {
            showStep(currentStep);
            modal.show();
        }
    });
    </script>
{% endblock %}
